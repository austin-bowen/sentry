<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentry</title>
    <style>
      body {
        font-family: sans-serif;
      }

      h1 {
        text-align: center;
      }

      #video_feed {
        display: block;
        margin: 0 auto;
        width: calc(min(1024px, 100%));
      }
    </style>
  </head>
  <body>
    <h1>Sentry</h1>

    <img id="video_feed" src="">

    <div id="joystick"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"
            integrity="sha512-HTENHrkQ/P0NGDFd5nk6ibVtCkcM7jhr2c7GyvXp5O+4X6O5cQO9AhqFzM+MdeBivsX7Hoys2J7pp2wdgMpCvw=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"></script>

    <!-- Joystick lib -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.0/nipplejs.min.js"></script>

    <script>
      class MotorController {
        constructor(socket) {
          this.socket = socket

          this.t_last_drive_command = new Date()
        }

        drive(linear, angular, force=false) {
          const dt_last_drive_command = (new Date() - this.t_last_drive_command) / 1000

          if (force || dt_last_drive_command > 0.1) {
            console.log('drive', linear, angular)
            this.socket.emit('motorController.drive', linear, angular)
            this.t_last_drive_command = new Date()
          }
        }

        stop() {
          console.log('stop')
          this.socket.emit('motorController.stop')
        }
      }

      const driveKeys = new Set(['W', 'A', 'S', 'D'])
      const pressedKeys = new Set()
      var motorController = null

      function main() {
        setupVideoFeed()
        setupMotorController()
        setupKeyboard()
        setupJoystick()
      }

      function setupVideoFeed() {
        const videoFeed = document.getElementById('video_feed')
        const videoFeedUrl = new URL(window.location.href)
        videoFeedUrl.port = {{ video_stream_port }}
        videoFeedUrl.pathname = '/video_feed'
        videoFeed.src = videoFeedUrl.href
      }

      function setupMotorController() {
        const socket = io()
        motorController = new MotorController(socket)

        window.onbeforeunload = () => {
          motorController.stop()
        }
      }

      function setupKeyboard() {
        document.addEventListener('keydown', event => {
          const key = event.key.toUpperCase()
          if (driveKeys.has(key) && !pressedKeys.has(key)) {
            pressedKeys.add(key)
            driveWithKeys()
          }
        })

        document.addEventListener('keyup', event => {
          const key = event.key.toUpperCase()
          if (driveKeys.has(key) && pressedKeys.has(key)) {
            pressedKeys.delete(key)
            driveWithKeys()
          }
        })
      }

      function driveWithKeys() {
        const forward = 'W'
        const backward = 'S'
        const left = 'A'
        const right = 'D'

        var linear = 0
        if (pressedKeys.has(forward) && !pressedKeys.has(backward)) {
          linear = getMaxLinearSpeed()
        } else if (!pressedKeys.has(forward) && pressedKeys.has(backward)) {
          linear = -getMaxLinearSpeed()
        }

        var angular = 0
        if (pressedKeys.has(left) && !pressedKeys.has(right)) {
          angular = getMaxAngularSpeed()
        } else if (!pressedKeys.has(left) && pressedKeys.has(right)) {
          angular = -getMaxAngularSpeed()
        }

        if (Math.abs(linear) > 0 && Math.abs(angular) > 0) {
          linear *= 0.707
          angular *= 0.707
        }

        if (linear != 0 || angular != 0) {
          motorController.drive(linear, angular, force=true)
        } else {
          motorController.stop()
        }
      }

      function setupJoystick() {
        const joystickManager = nipplejs.create({
          zone: document.getElementById('joystick'),
          color: 'black',
          position: {left: '5rem', bottom: '5rem'},
          mode: 'static',
        })

        joystickManager.on('end', function(event, joystick) {
          motorController.stop()
        })

        joystickManager.on('move', function(event, joystick) {
          handleJoystickMovement(joystick.vector.x, joystick.vector.y)
        })
      }

      function handleJoystickMovement(x, y) {
        const linear = joystickToLinearVelocity(y)
        const angular = joystickToAngularVelocity(x)

        // TODO: Reverse angular if linear is negative?

        motorController.drive(linear, angular)
      }

      function joystickToLinearVelocity(position) {
        if (Math.abs(position) < 0.1) {
          return 0.0
        }

        return position * getMaxLinearSpeed()
      }

      function getMaxLinearSpeed() {
        return 0.25
      }

      function joystickToAngularVelocity(position) {
        if (Math.abs(position) < 0.1) {
          return 0.0
        }

        return -position * getMaxAngularSpeed()
      }

      function getMaxAngularSpeed() {
        return Math.PI / 3
      }

      main()
    </script>
  </body>
</html>
